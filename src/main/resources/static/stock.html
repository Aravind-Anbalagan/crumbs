<!-- Saved as: stock-indicators.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Indicators Table</title>
  <style>
    :root {
      --table-font-size: 14px;
      --bg-col-name: #e3f2fd;
      --bg-col-price: #e8f5e9;
      --bg-col-dailysr: #fff3e0;
      --bg-col-sr: #f3e8ff;
      --bg-col-fibo: #e6fff7;
      --bg-col-ma: #fffbe6;
      --bg-col-ai: #ffeaea;
      --bg-col-combine: #e0f7fa;
    }

    body.dark-mode {
      background-color: #1e1e1e;
      color: #f5f5f5;
      --bg-col-name: #2a3b4c;
      --bg-col-price: #2e4433;
      --bg-col-dailysr: #4d3b26;
      --bg-col-sr: #493d5b;
      --bg-col-fibo: #1f4033;
      --bg-col-ma: #464226;
      --bg-col-ai: #4d2c2c;
      --bg-col-combine: #264d4f;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 12px;
      margin: 0;
      background-color: #f9f9f9;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .column-dropdown {
      position: relative;
      display: inline-block;
    }

    .column-dropdown button {
      padding: 5px 10px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      border-radius: 4px;
      cursor: pointer;
    }

    .column-dropdown-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 180px;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      z-index: 10;
      padding: 8px;
    }

    .column-dropdown.show .column-dropdown-content {
      display: block;
    }

    body.dark-mode .column-dropdown-content {
      background-color: #2c2c2c;
      color: #f5f5f5;
      border-color: #777;
    }

    .refresh-btn,
    .theme-toggle {
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }

    .theme-toggle {
      margin-left: auto;
    }

    input[type="text"],
    select {
      padding: 5px;
      min-width: 140px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }

    th,
    td {
      border: 1px solid #999;
      padding: 6px 8px;
      text-align: left;
      word-break: break-word;
      font-size: var(--table-font-size);
    }

    thead th {
      position: sticky;
      top: 0;
      background: inherit;
      z-index: 2;
    }

    th {
      font-weight: bold;
      cursor: pointer;
      position: relative;
      padding-right: 18px;
    }

    th.sort-asc::after {
      content: " \25B2";
    }

    th.sort-desc::after {
      content: " \25BC";
    }

    th.col-name,
    td.col-name {
      background-color: var(--bg-col-name) !important;
    }

    th.col-price,
    td.col-price {
      background-color: var(--bg-col-price) !important;
    }

    th.col-dailysr,
    td.col-dailysr {
      background-color: var(--bg-col-dailysr) !important;
    }

    th.sr,
    td.sr {
      background-color: var(--bg-col-sr) !important;
    }

    th.fibo,
    td.fibo {
      background-color: var(--bg-col-fibo) !important;
    }

    th.ma,
    td.ma {
      background-color: var(--bg-col-ma) !important;
    }

    th.ai,
    td.ai {
      background-color: var(--bg-col-ai) !important;
    }

    th.combine,
    td.combine {
      background-color: var(--bg-col-combine) !important;
    }

    body.dark-mode table,
    body.dark-mode th,
    body.dark-mode td {
      border-color: #555;
    }

    body.dark-mode th,
    body.dark-mode td {
      background-color: #2c2c2c;
      color: #f5f5f5;
    }

    body.dark-mode input,
    body.dark-mode select {
      background-color: #2c2c2c;
      color: #f5f5f5;
      border: 1px solid #777;
    }

    #pagination {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      align-items: center;
    }

    .page-link {
      cursor: pointer;
      padding: 4px 8px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      border-radius: 4px;
      user-select: none;
    }

    .page-link.active {
      font-weight: bold;
      background: #e0e0e0;
    }

    #loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 700px) {
      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 6px;
        background: #fff;
      }

      td {
        padding-left: 50%;
        position: relative;
        border: none;
        border-bottom: 1px solid #ddd;
      }

      td::before {
        position: absolute;
        top: 6px;
        left: 6px;
        width: 45%;
        font-weight: bold;
        white-space: nowrap;
        content: attr(data-label);
      }

      .toolbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
    }

    h1,
    h2 {
      margin: 4px 0;
    }

    #errorMessage {
      color: #b00020;
      background: #fdecea;
      border: 1px solid #f5c6cb;
      padding: 8px 12px;
      margin-bottom: 10px;
      display: none;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <div class="controls">
      <label for="timeframe">Timeframe:</label>
      <select id="timeframe" onchange="updateSecondaryFilter(); loadTable()">
        <option value="DAILY">Daily</option>
        <option value="WEEKLY">Weekly</option>
        <option value="COMBINE">Combine</option>
        <option value="INTRADAY">Intraday</option>
      </select>

      <label id="secondaryFilterLabel" for="secondaryFilter">Heikin/Psar:</label>
<select id="secondaryFilter" onchange="loadTable()">
  <option value="ALL">All</option>
  <option value="FIRST BUY">First Buy</option>
  <option value="FIRST SELL">First Sell</option>
</select>

      <button class="refresh-btn" onclick="resetTable()">ðŸ§¹ Reset</button>

      <div class="column-dropdown" id="columnDropdown">
        <button onclick="toggleColumnDropdown()">â˜° Hide Columns</button>
        <div class="column-dropdown-content" id="columnTogglePanel"></div>
      </div>

      <label for="search">Filter:</label>
      <input type="text" id="search" placeholder="Search..." onkeyup="filterTable()" autocomplete="off" />
    </div>

    <div style="margin-left:auto; display:flex; gap:5px; flex-wrap:wrap;">
      <button class="refresh-btn" onclick="zoomIn()">âž• A</button>
      <button class="refresh-btn" onclick="zoomOut()">âž– A</button>
      <button class="refresh-btn" onclick="resetZoom()">ðŸ”„ A</button>
      <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™</button>
    </div>
  </div>

  <div id="errorMessage" role="alert"></div>

  <div class="table-container">
    <table id="stocksTable">
      <thead>
        <tr id="tableHead"></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="pagination"></div>

  <div id="loader">
    <div class="spinner"></div>
    <div style="margin-top: 12px;">Loading data...</div>
  </div>

<script>
let tableData = [], filteredData = [], visibleKeys = [];
let sortState = { column: null, order: null };
let currentPage = 1, currentFontSize = 14;
const rowsPerPage = 10;
let columnVisibility = {};

// --- FONT SIZE / ZOOM ---
function updateFontSize() {
    document.documentElement.style.setProperty('--table-font-size', `${currentFontSize}px`);
    localStorage.setItem('tableFontSize', currentFontSize);
}

function zoomIn() { if (currentFontSize < 24) { currentFontSize++; updateFontSize(); } }
function zoomOut() { if (currentFontSize > 8) { currentFontSize--; updateFontSize(); } }
function resetZoom() { currentFontSize = 14; updateFontSize(); }

// --- LOAD TABLE DATA ---
function updateSecondaryFilter() {
    const tf = document.getElementById("timeframe").value;
    const label = document.getElementById("secondaryFilterLabel");
    const select = document.getElementById("secondaryFilter");

    select.innerHTML = ""; // clear old options
    if (tf === "INTRADAY") {
        label.textContent = "Trend:";
        ["ALL", "UP", "DOWN"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0) + val.slice(1).toLowerCase();
            select.appendChild(opt);
        });
    } else {
        label.textContent = "Heikin/Psar:";
        ["ALL", "FIRST BUY", "FIRST SELL"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.split(" ").map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(" ");
            select.appendChild(opt);
        });
    }
}

async function loadTable() {
    const timeframe = document.getElementById("timeframe").value;
    const filter = document.getElementById("secondaryFilter").value;
    const loader = document.getElementById("loader");
    const errorDiv = document.getElementById("errorMessage");

    errorDiv.style.display = "none";
    loader.style.display = "flex";

    try {
        let url;
        if (timeframe === "INTRADAY") {
            url = `/api/indicators/flagged?flag=${timeframe}&trendFilter=${encodeURIComponent(filter)}`;
        } else {
            url = `/api/indicators/flagged?flag=${timeframe}&heikinPsarFilter=${encodeURIComponent(filter)}`;
        }

        const res = await fetch(url);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if (!data.length) throw new Error("No stock data found for the selected filters.");

        visibleKeys = Object.entries(data[0].headers)
            .filter(([_, val]) => val[1])
            .map(([key]) => key);

        tableData = data.map(row => Object.fromEntries(visibleKeys.map(k => [k, row.headers[k][0]])));
        filteredData = [...tableData];
        currentPage = 1;

        generateColumnToggles();
        renderTable();
    } catch (err) {
        showError(err.message || "Could not load data.");
        tableData = filteredData = [];
        renderTable();
    } finally {
        loader.style.display = "none";
    }
}


// --- COLUMN TOGGLE PANEL ---
function generateColumnToggles() {
    const panel = document.getElementById("columnTogglePanel");
    panel.innerHTML = "";
    visibleKeys.forEach(key => {
        if (!(key in columnVisibility)) columnVisibility[key] = true;

        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = columnVisibility[key];
        checkbox.onchange = () => { columnVisibility[key] = checkbox.checked; renderTable(); };
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.gap = "4px";
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(formatHeader(key)));
        panel.appendChild(label);
    });
}

// --- COLUMN CLASS HELPER ---
function getColumnClass(key) {
    const lowerKey = key.toLowerCase();
    if (lowerKey === "name") return "col-name";
    if (lowerKey === "price") return "col-price";
    if (["daily s/r", "daily_sr", "dailysr"].includes(lowerKey)) return "col-dailysr";
    if (lowerKey.includes("sr")) return "sr";
    if (lowerKey.includes("fibo")) return "fibo";
    if (lowerKey.includes("ma") || lowerKey.includes("rsi")) return "ma";
    if (lowerKey.includes("ai")) return "ai";
    if (lowerKey.includes("combine")) return "combine";
    return "";
}

// --- RENDER TABLE ---
function renderTable() {
    const head = document.getElementById("tableHead");
    const body = document.getElementById("tableBody");
    head.innerHTML = body.innerHTML = "";

    // HEADERS
    visibleKeys.forEach(key => {
        if (!columnVisibility[key]) return;
        const th = document.createElement("th");
        th.textContent = formatHeader(key);
        const className = getColumnClass(key);
        if (className) th.classList.add(className);
        th.onclick = () => sortTableByColumn(key);
        if (sortState.column === key) {
            th.classList.add(sortState.order === 'asc' ? 'sort-asc' : 'sort-desc');
        }
        head.appendChild(th);
    });

    // NO DATA
    if (!filteredData.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = visibleKeys.length || 1;
        td.textContent = "No records found.";
        td.style.textAlign = "center";
        tr.appendChild(td);
        body.appendChild(tr);
        return;
    }

    // PAGE DATA
    const start = (currentPage - 1) * rowsPerPage;
    const end = currentPage * rowsPerPage;
    filteredData.slice(start, end).forEach(row => {
        const tr = document.createElement("tr");
        visibleKeys.forEach(key => {
            if (!columnVisibility[key]) return;
            const td = document.createElement("td");
            td.setAttribute("data-label", formatHeader(key));
            td.textContent = row[key];
            const className = getColumnClass(key);
            if (className) td.classList.add(className);
            tr.appendChild(td);
        });
        body.appendChild(tr);
    });

    renderPagination();
}

// --- PAGINATION ---
function renderPagination() {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    const container = document.getElementById("pagination");
    container.innerHTML = "";
    if (totalPages <= 1) return;

    const createLink = (label, page, active = false) => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.className = "page-link" + (active ? " active" : "");
        btn.onclick = () => { currentPage = page; renderTable(); };
        return btn;
    };

    if (currentPage > 1) container.append(createLink("Â« First", 1), createLink("Prev", currentPage - 1));

    let start = Math.max(1, currentPage - 2);
    let end = Math.min(totalPages, currentPage + 2);
    if (currentPage <= 3) end = Math.min(5, totalPages);
    if (currentPage >= totalPages - 2) start = Math.max(totalPages - 4, 1);

    if (start > 1) { container.append(createLink(1, 1)); if (start > 2) container.append(document.createElement("span").textContent = "..."); }
    for (let i = start; i <= end; i++) container.append(createLink(i, i, i === currentPage));
    if (end < totalPages) { if (end < totalPages - 1) container.append(document.createElement("span").textContent = "..."); container.append(createLink(totalPages, totalPages)); }

    if (currentPage < totalPages) container.append(createLink("Next", currentPage + 1), createLink("Last Â»", totalPages));
}

// --- SORT ---
function sortTableByColumn(col) {
    const isAsc = sortState.column === col && sortState.order === 'asc';
    sortState = { column: col, order: isAsc ? 'desc' : 'asc' };
    filteredData.sort((a, b) => {
        let valA = a[col] != null ? a[col].toString().trim() : '';
        let valB = b[col] != null ? b[col].toString().trim() : '';
        const numA = parseFloat(valA.replace(/[^0-9.\-]/g, ''));
        const numB = parseFloat(valB.replace(/[^0-9.\-]/g, ''));
        return (!isNaN(numA) && !isNaN(numB)) ? (isAsc ? numA - numB : numB - numA) : (isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA));
    });
    currentPage = 1;
    renderTable();
}

// --- FILTER ---
function filterTable() {
    const keyword = document.getElementById("search").value.toLowerCase();
    filteredData = tableData.filter(row => visibleKeys.some(k => (row[k] + '').toLowerCase().includes(keyword)));
    currentPage = 1;
    renderTable();
}

// --- RESET TABLE ---
function resetTable() {
    document.getElementById("timeframe").value = "DAILY";
    document.getElementById("heikinPsarFilter").value = "ALL";
    document.getElementById("search").value = "";
    document.getElementById("errorMessage").style.display = "none";
    currentPage = 1;
    loadTable();
}

// --- ERROR MESSAGE ---
function showError(msg) {
    const errDiv = document.getElementById("errorMessage");
    errDiv.innerText = msg;
    errDiv.style.display = "block";
}

// --- FORMAT HEADER ---
function formatHeader(key) {
    return key.replace(/[_\s]+/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// --- COLUMN DROPDOWN ---
function toggleColumnDropdown() {
    document.getElementById("columnDropdown").classList.toggle("show");
}

// --- THEME ---
function toggleTheme() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem('theme', document.body.classList.contains("dark-mode") ? 'dark' : 'light');
}

// --- INITIAL SETTINGS ---
document.addEventListener("DOMContentLoaded", () => {
    const storedFont = parseInt(localStorage.getItem('tableFontSize'));
    if (storedFont) { currentFontSize = storedFont; updateFontSize(); }
    const theme = localStorage.getItem('theme');
    if (theme === 'dark') document.body.classList.add("dark-mode");
    loadTable();
});
</script>

</body>

</html>